pipeline {
    agent {
        kubernetes {
            label 'github_deployment'
			defaultContainer 'xc16-mplabx-sonar-fmpp-python'
            yamlFile '.citd/cloudprovider.yml'
        }
    }

	environment {
	    NOTIFICATION_EMAIL = 'e50beea8.microchip.com@amer.teams.ms'	
		//This is the BitBucket source repo URL to be deployed
		BITBUCKET_SOURCE_URL = 'https://bitbucket.microchip.com/scm/~i50992/example-multi-mplabx-project-deployment.git'
		GITHUB_URL = 'https://github.com/mchpTestArea'
	    GITHUB_CREDENTIAL_ID = 'GITHUB_PIC_AVR_TEST_TOKEN'
		//Files or folders to be excluded from deployment, if multiple files or folders use comma separator
		DEPLOY_EXCLUDE_FOLDER_FILE_LIST = 'mchp_private'
		//Branch(s) to be deployed, if multiple branches use comma separator. ${env.BRANCH_NAME} is the target branch of the PR.
		DEPLOY_BRANCH_LIST = "${env.BRANCH_NAME}"
		CHANGE_LOG_PATH = 'changelog.md'
		SOURCE_PROJECT_META_DATA = '.main-meta/main.json'
		DEPLOY_TOOL_URL = 'https://bitbucket.microchip.com/scm/citd/tool-github-deploy.git'
	}

    options {
        timestamps()
        timeout(time: 20, unit: 'MINUTES')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }
		
        // stage('Build') {
        //     steps {
        //         script {
        //            execute("git clone https://bitbucket.microchip.com/scm/citd/tool-mplabx-c-build.git")
        //            execute("cd ./tool-mplabx-c-build && node buildLauncher.js sp=../ rp=./output genMK=true")
        //        }
        //     }
        // }
		// 
        // // Cloning the tool used for GitHub deployment
	   	// stage('GitHub tool clone'){
        //     steps{
        //        script{
        //             execute("git clone ${env.DEPLOY_TOOL_URL}")
        //             execute("cd tool-github-deploy && git checkout develop")
        //         }
        //     }
        // }
        // 
        // // GitHub repo creation 
	    // stage('GitHub Repo Creation') {
        //     steps{
        //         script{
        //             def jsonObj = readJsonObject();
        //             
        //             String [] topics = jsonObj.content.keywords
        //             def asString = topics.join(", ")
        //             asString = asString.replace("\n", "").replace(" ", "").replace("\t", "").replace("\r", "")
		// 			Boolean visibility =  false
        //             
        //             withCredentials([usernamePassword(credentialsId: "${env.GITHUB_CREDENTIAL_ID}", passwordVariable: 'PASS', usernameVariable: 'USER_NAME')]) {
        //                 execute("python tool-github-deploy/tool-github-deploy/tool-github-deploy.py -rpo=true -gpat=$PASS -rporg=${env.GITHUB_URL} -rpn=${jsonObj.content.projectName} -rpd=\"${jsonObj.content.shortDescription}\" -rpt=${asString} -rpp=${visibility}")
        //             }
        //         }
        //     }
        // } 
        // 
	    // // Deploying the code to GitHub 
		// stage('GitHub Deploy Source'){
        //     steps{
        //         script{
        //             def jsonObj = readJsonObject();
        //             def gitHubUrl = "${env.GITHUB_URL}" + "/" + jsonObj.content.projectName
        //             gitHubUrl = gitHubUrl.replace(" ", "").replace("\n", "")
        //             
        //             withCredentials([usernamePassword(credentialsId: "${env.GITHUB_CREDENTIAL_ID}", passwordVariable: 'PASS', usernameVariable: 'USER_NAME')]) {
        //                 execute("python tool-github-deploy/tool-github-deploy/tool-github-deploy.py -deploy=true -gpat=$PASS -dgid=$USER_NAME -dburl=${env.BITBUCKET_SOURCE_URL} -dgurl=${gitHubUrl}")
        //             }
        //         }
        //     }
        // }
		// 
		// // Creating GitHub release  
		// stage('GitHub release'){
        //      steps{
        //         script{
        //              def jsonObj = readJsonObject();
		// 
        //              withCredentials([usernamePassword(credentialsId: "${env.GITHUB_CREDENTIAL_ID}", passwordVariable: 'PASS', usernameVariable: 'USER_NAME')]) {
        //                  execute("python tool-github-deploy/tool-github-deploy/tool-github-deploy.py -rlo=true -gpat=$PASS -rporg=${env.GITHUB_URL} -rpn=\"${jsonObj.content.projectName}\" -rltv=\"${jsonObj.content.version}\" -rltt=\"${jsonObj.content.version}\" -rlnp=${env.CHANGE_LOG_PATH}")
        //             }
        //         }
        //     }
        // }
		
		//Deploying the Github content to portal
		stage('Portal-Deploy') {
			steps {
				script {
                    def projectFolderList = multipleProjectListGet()
                    
                    // If Multiple project folder is found
                    if(projectFolderList.size() > 1) {
                        
                        def githubUrlSplitList = "${env.GIT_URL}".split('/')

                        execute("git clone https://bitbucket.microchip.com/scm/portal/bundles.git")
                        execute("cd bundles && chmod 755 ./portal-client-cli-linux")
                        
                        execute("git clone https://bitbucket.microchip.com/scm/~i15784/tool-portal-client-launcher.git")
                        execute("cd tool-portal-client-launcher && git checkout feature/switch-portal-server")
                        
                        
                        def jsonObjData = readJsonObject();
                        
                        projectFolderList.each { item -> 
                            
                            def itemSplitList = item.split('\\|')
                            
							def metaDataPath = multiProjectMetaDataJsonFilePathGet(itemSplitList[0])
							
							println metaDataPath
                            
							def jsonObj = readJsonObject(itemSplitList[0] + "/.main-meta/main.json");			
                            def version = jsonObj.content.version
                            
                            def projectPath = itemSplitList[1].replace(".", "").replace("/", "")
                            
                            String[] splitPreTag = "${env.GITHUB_URL}".split("/")
                            def gitHubOrg = (splitPreTag[splitPreTag.size() - 1])
                            
                            def cmdArgs = "'{\"repoOwnerName\":\"${gitHubOrg}\", \"repoName\":\"${jsonObjData.content.projectName}\", \"projectPath\": \"${projectPath}\", \"tagName\":\"$version\"}'"
                            cmdArgs = cmdArgs.replaceAll("\"","\\\\\"")						
                            
                            println cmdArgs                            
                            
                            execute("cd tool-portal-client-launcher && node portalLauncher.js -app=../bundles/portal-client-cli-linux -srv=\"staging\" -cmd=\"uploadGitHub ${cmdArgs}\"")     
                        }                      
                    } else {
                        def jsonObj = readJsonObject();			
                        def version = jsonObj.content.version
                        def project = jsonObj.content.projectName
                        
                        String[] splitPreTag = "${env.GITHUB_URL}".split("/")
                        def gitHubOrg = (splitPreTag[splitPreTag.size() - 1])

                        def cmdArgs = "'{\"repoOwnerName\":\"$gitHubOrg\",\"repoName\":\"$project\",\"tagName\":\"$version\"}'"
                        cmdArgs = cmdArgs.replaceAll("\"","\\\\\"")		
                        
                        println cmdArgs
                            
                        execute("git clone https://bitbucket.microchip.com/scm/portal/bundles.git")
                        execute("cd bundles && chmod 755 ./portal-client-cli-linux")
                        execute("git clone https://bitbucket.microchip.com/scm/citd/tool-portal-client-launcher.git")
                        execute("cd tool-portal-client-launcher && node portalLauncher.js -app=../bundles/portal-client-cli-linux -cmd=\"uploadGitHub ${cmdArgs}\"")
                    }
				}
			}
		}        
    }

    post {
        success{
            script {
                if (!"${env.CHANGE_AUTHOR_EMAIL}".equalsIgnoreCase("null")) {
				    
                    mail to: "${env.CHANGE_AUTHOR_EMAIL}, ${env.NOTIFICATION_EMAIL}",
                    subject: "Successful Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Something is right with ${env.BUILD_URL}"
                } else {
				    
                    mail to: "${env.NOTIFICATION_EMAIL}",
                    subject: "Successful Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Something is right with ${env.BUILD_URL}"
                }
            }
        }
        failure {
            script {
                if (!"${env.CHANGE_AUTHOR_EMAIL}".equalsIgnoreCase("null")) {				    
                    mail to: "${env.CHANGE_AUTHOR_EMAIL}, ${env.NOTIFICATION_EMAIL}",
                    subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Pipeline failure. ${env.BUILD_URL}"
                } else {
                    mail to: "${env.NOTIFICATION_EMAIL}",
                    subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
                    body: "Pipeline failure. ${env.BUILD_URL}"
                }
            }
        }
    }
}

def execute(String command) {
    if (isUnix()) {
        sh command
    } else {
        bat command
    }
}

String readJsonObject() {
    def jsonObj  = readJSON interpolate: true, file: "${env.SOURCE_PROJECT_META_DATA}"
    return jsonObj
}

String readJsonObject(String metaDataFileName) {
    def jsonObj  = readJSON interpolate: true, file: "${metaDataFileName}"
    return jsonObj
}

def multiProjectMetaDataJsonFilePathGet(String projectPath) {
	dir = sh(script: "find -name \"main.json\"", returnStdout: true).trim()
    dir = dir.split('\n')
	
	def filePathStr = ""

    dir.each { str ->
		println str
        if(str.indexOf("main.json") > -1) {
			println str
			return filePathStr;
        }
    }
	
	return filePathStr;
}

def projectRootFolderPathGet(String folderPath, Boolean frontSlash) {
    def splitList = []
    String projectName;
    
    if(frontSlash) {
        splitList = folderPath.split('\\\\')
    } else {
        splitList = folderPath.split('/')
    }

    projectName = (splitList[splitList.size() - 1])      
    
    return folderPath.replace(projectName, "") + "|" + (splitList[splitList.size() - 2])     
}

def multipleProjectListGet() {
    def list = []
    def dir = []
    dir = sh(script: "find -type f -name \"configurations.xml\"", returnStdout: true).trim()
    
    dir = dir.split('\n')
        
    def filePathStr = ""
    
    dir.each { str ->
        if(str.indexOf("deploy_sandbox") < 0) {
            if(str.indexOf("nbproject/configurations.xml") > -1) {
                filePathStr = str.replace("/nbproject/configurations.xml", "")
                filePathStr = projectRootFolderPathGet(filePathStr, false)
                list.add(filePathStr)
                println str

            
            } else if(str.indexOf("nbproject\\configurations.xml") > -1) {
                filePathStr = str.replace("\\nbproject\\configurations.xml", "")
                filePathStr = projectRootFolderPathGet(filePathStr, true)
                list.add(filePathStr)
                println str
            }
        }
    }
    
    return list
}

def getGitHubUrl(String productionUrl, String testDeployUrl) {
    String branchName = "${env.BRANCH_NAME}";
    if(branchName == 'master') {
        return productionUrl;
    } else if(branchName == 'test_deploy') {
        return testDeployUrl;
    } else {
        return null
    }
}

def getGitHubCredentialId(String deployUrl, String productionDeployUrl, String testDeployUrl, String githubProductionDeployCredential, String githubTestDeployCredential) {    
    if(deployUrl == productionDeployUrl) {
        return githubProductionDeployCredential;
    } else if(deployUrl == testDeployUrl) {
        return githubTestDeployCredential;
    } else {
        return null
    }
}